<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin Panel | South Width</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  background:#0e0e0e;
  color:#fff;
  font-family:Arial;
  padding:40px
}
h1{margin-bottom:20px}
.section{
  border:1px solid #333;
  padding:20px;
  margin-bottom:30px
}
.item{
  padding:10px;
  border-bottom:1px solid #222;
  font-size:14px
}
.item:last-child{border:none}
.badge{
  background:#444;
  padding:4px 8px;
  font-size:12px;
  margin-left:8px
}
input,button{
  padding:8px;
  margin-top:8px;
  width:100%
}
button{
  background:#fff;
  border:none;
  cursor:pointer;
  font-weight:600
}
button:hover{opacity:.8}
.logout{
  color:#ff5f5f;
  cursor:pointer;
  margin-bottom:30px;
  display:inline-block
}
</style>
</head>

<body>

<h1>Panel Admin – South Width</h1>
<div class="logout" id="logout">Cerrar sesión</div>

<!-- USUARIOS -->
<div class="section">
  <h3>Usuarios registrados</h3>
  <div id="users"></div>
</div>

<!-- CUPONES -->
<div class="section">
  <h3>Cupones de descuento</h3>

  <input id="code" placeholder="Código del cupón">
  <input id="discount" type="number" placeholder="% de descuento">
  <button onclick="createCoupon()">Crear / Actualizar cupón</button>

  <div id="coupons" style="margin-top:20px"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore,collection,getDocs,doc,setDoc,updateDoc } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAVyVlXFJuVF3snNO3fvQy1ud1WGo15ri4",
  authDomain: "south-width.firebaseapp.com",
  projectId: "south-width",
  storageBucket: "south-width.firebasestorage.app",
  messagingSenderId: "144617776304",
  appId: "1:144617776304:web:6ed82ac4dcb2354a620775"
};

const ADMINS = [
  "admin@southwidth.cl",
  "alexandersteam1213@gmail.com"
];

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* PROTECCIÓN ADMIN */
onAuthStateChanged(auth,user=>{
  if(!user || !ADMINS.includes(user.email.toLowerCase())){
    location.href="index.html";
  } else {
    loadUsers();
    loadCoupons();
  }
});

/* LOGOUT */
document.getElementById("logout").onclick=()=>{
  signOut(auth).then(()=>location.href="index.html");
};

/* USUARIOS */
async function loadUsers(){
  const cont=document.getElementById("users");
  cont.innerHTML="";
  const snap=await getDocs(collection(db,"usuarios"));

  snap.forEach(docu=>{
    const u=docu.data();
    cont.innerHTML+=`
      <div class="item">
        ${u.nombre || "Sin nombre"}
        <span class="badge">${u.email}</span>
        <span class="badge">${u.provider}</span>
      </div>
    `;
  });
}

/* CUPONES */
window.createCoupon = async ()=>{
  const code=document.getElementById("code").value.toUpperCase();
  const discount=parseInt(document.getElementById("discount").value);

  if(!code || !discount) return alert("Completa los datos");

  await setDoc(doc(db,"cupones",code),{
    descuento: discount,
    activo: true
  });

  document.getElementById("code").value="";
  document.getElementById("discount").value="";
  loadCoupons();
};

async function loadCoupons(){
  const cont=document.getElementById("coupons");
  cont.innerHTML="";
  const snap=await getDocs(collection(db,"cupones"));

  snap.forEach(docu=>{
    const c=docu.data();
    cont.innerHTML+=`
      <div class="item">
        <strong>${docu.id}</strong> - ${c.descuento}% 
        <span class="badge">${c.activo ? "Activo" : "Inactivo"}</span>
        <button onclick="toggleCoupon('${docu.id}',${c.activo})">
          ${c.activo ? "Desactivar" : "Activar"}
        </button>
      </div>
    `;
  });
}

window.toggleCoupon = async (id,state)=>{
  await updateDoc(doc(db,"cupones",id),{
    activo: !state
  });
  loadCoupons();
};
</script>

</body>
</html>
